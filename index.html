<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Kasir Kios</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
        @media print {
            body * {
                visibility: hidden;
            }
            #struk-content, #struk-content * {
                visibility: visible;
            }
            #struk-content {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                padding: 20px;
            }
        }
    </style>
</head>
<body class="p-4">
    <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-lg p-6 md:p-8">
        <h1 class="text-3xl md:text-4xl font-bold text-center text-gray-800 mb-6">Aplikasi Kasir Kios</h1>
        <p class="text-center text-gray-600 mb-8">Tambahkan barang dagangan dan hitung totalnya dengan mudah!</p>
        
        <!-- Form untuk menambahkan barang baru -->
        <div class="mb-8 p-6 bg-gray-50 rounded-lg shadow-sm">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">Tambah Barang Baru</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="namaBarang1" class="block text-sm font-medium text-gray-700 mb-1">Nama Barang</label>
                    <input type="text" id="namaBarang1" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="Contoh: Kopi Sachet">
                </div>
                <div>
                    <label for="hargaBarang1" class="block text-sm font-medium text-gray-700 mb-1">Harga (Rp)</label>
                    <input type="number" id="hargaBarang1" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="Contoh: 3000">
                </div>
                <div>
                    <label for="namaBarang2" class="block text-sm font-medium text-gray-700 mb-1">Nama Barang</label>
                    <input type="text" id="namaBarang2" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="Contoh: Teh Celup">
                </div>
                <div>
                    <label for="hargaBarang2" class="block text-sm font-medium text-gray-700 mb-1">Harga (Rp)</label>
                    <input type="number" id="hargaBarang2" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="Contoh: 2500">
                </div>
            </div>
            <button id="tambahBarangBtn" class="mt-4 w-full md:w-auto px-6 py-2 bg-blue-600 text-white font-medium rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition ease-in-out duration-150">Tambah ke Daftar Barang</button>
        </div>

        <!-- Daftar Barang yang sudah diinput -->
        <div class="mb-8 p-6 bg-gray-50 rounded-lg shadow-sm">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">Daftar Barang</h2>
            <div id="daftarBarangContainer" class="space-y-4">
                <!-- Daftar barang permanen akan muncul di sini -->
            </div>
            <div id="paginationControls" class="flex justify-center mt-4 space-x-2">
                <!-- Tombol-tombol halaman akan muncul di sini -->
            </div>
        </div>

        <!-- Keranjang Belanja -->
        <div class="mb-8 p-6 bg-gray-50 rounded-lg shadow-sm">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">Keranjang Belanja</h2>
            <div id="keranjangContainer" class="space-y-4">
                <!-- Barang yang ditambahkan akan muncul di sini -->
            </div>
        </div>
        
        <!-- Total Harga dan Pembayaran -->
        <div class="p-6 bg-blue-100 rounded-lg shadow-inner mb-6">
            <h2 class="text-xl font-semibold text-blue-800 mb-4">Ringkasan Pembelian</h2>
            <div class="flex justify-between items-center mb-2">
                <span class="text-gray-700 font-medium">Total Harga:</span>
                <span id="totalHarga" class="font-bold text-gray-900">Rp 0</span>
            </div>
            <div class="mt-4">
                <label for="jumlahUang" class="block text-sm font-medium text-gray-700 mb-1">Jumlah Uang Diterima (Rp)</label>
                <p class="text-xs text-gray-500 mb-1">Masukkan jumlah uang tunai yang diberikan pelanggan.</p>
                <input type="number" id="jumlahUang" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="Contoh: 50000">
            </div>
            <div class="flex justify-between items-center mt-4 pt-4 border-t border-gray-300">
                <span class="text-gray-700 font-medium">Uang Kembalian:</span>
                <span id="uangKembalian" class="font-bold text-green-700">Rp 0</span>
            </div>
            <div class="mt-6 flex flex-col md:flex-row gap-4">
                <button id="resetBtn" class="flex-1 px-6 py-2 bg-red-600 text-white font-medium rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition ease-in-out duration-150">Reset Pembelian</button>
                <button id="cetakStrukBtn" class="flex-1 px-6 py-2 bg-green-600 text-white font-medium rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition ease-in-out duration-150">Cetak Struk</button>
            </div>
        </div>
    </div>
    
    <!-- Konten struk yang akan dicetak, disembunyikan secara default -->
    <div id="struk-content" class="hidden">
        <!-- Konten akan dihasilkan di sini oleh JavaScript -->
    </div>

    <script type="module">
        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Authenticate the user
        let userId;
        async function authenticate() {
            try {
                if (initialAuthToken) {
                    const userCredential = await signInWithCustomToken(auth, initialAuthToken);
                    userId = userCredential.user.uid;
                } else {
                    const userCredential = await signInAnonymously(auth);
                    userId = userCredential.user.uid;
                }
                console.log("Authentication successful. User ID:", userId);
                startApp();
            } catch (error) {
                console.error("Authentication failed:", error);
            }
        }
        authenticate();

        // Menginisialisasi elemen-elemen DOM
        const namaBarang1Input = document.getElementById('namaBarang1');
        const hargaBarang1Input = document.getElementById('hargaBarang1');
        const namaBarang2Input = document.getElementById('namaBarang2');
        const hargaBarang2Input = document.getElementById('hargaBarang2');
        const tambahBarangBtn = document.getElementById('tambahBarangBtn');
        const keranjangContainer = document.getElementById('keranjangContainer');
        const daftarBarangContainer = document.getElementById('daftarBarangContainer');
        const paginationControls = document.getElementById('paginationControls');
        const totalHargaSpan = document.getElementById('totalHarga');
        const jumlahUangInput = document.getElementById('jumlahUang');
        const uangKembalianSpan = document.getElementById('uangKembalian');
        const resetBtn = document.getElementById('resetBtn');
        const cetakStrukBtn = document.getElementById('cetakStrukBtn');

        // Variabel untuk menyimpan data
        let keranjang = [];
        let daftarBarang = [];
        let currentPage = 1;
        const itemsPerPage = 10;
        
        let daftarBarangUnsubscribe;

        // Fungsi untuk mengupdate tampilan daftar barang permanen dengan pagination
        function updateDaftarBarang() {
            daftarBarangContainer.innerHTML = '';
            
            if (daftarBarang.length === 0) {
                daftarBarangContainer.innerHTML = `<p class="text-gray-500 italic">Belum ada barang yang ditambahkan.</p>`;
                paginationControls.innerHTML = '';
                return;
            }

            // Menghitung halaman
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const itemsToShow = daftarBarang.slice(startIndex, endIndex);

            itemsToShow.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'flex flex-col md:flex-row md:items-center justify-between bg-white p-4 rounded-lg shadow-md';
                
                // Tambahkan tombol hapus baru
                itemDiv.innerHTML = `
                    <div class="flex-1">
                        <span class="font-medium text-gray-800 block md:inline">${item.nama}</span>
                        <span class="text-gray-600 block md:inline md:ml-4">Rp ${item.harga.toLocaleString('id-ID')}</span>
                    </div>
                    <div class="mt-2 md:mt-0 flex items-center space-x-2">
                        <input type="number" class="harga-input w-24 p-1 text-sm border border-gray-300 rounded-md" placeholder="Harga Baru" data-index="${index}">
                        <button class="perbarui-harga-btn text-blue-500 hover:text-blue-700 transition-colors duration-200" data-index="${index}" title="Perbarui Harga">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M4.5 13.5C4.5 14.3284 5.17157 15 6 15H14C14.8284 15 15.5 14.3284 15.5 13.5V11C15.5 10.1716 14.8284 9.5 14 9.5H6C5.17157 9.5 4.5 10.1716 4.5 11V13.5ZM10 6.5C11.3807 6.5 12.5 7.61929 12.5 9H7.5C7.5 7.61929 8.61929 6.5 10 6.5ZM17 9.5V13.5C17 15.433 15.433 17 13.5 17H6.5C4.567 17 3 15.433 3 13.5V9.5C3 7.567 4.567 6 6.5 6H7.5C7.5 4.61929 8.61929 3.5 10 3.5C11.3807 3.5 12.5 4.61929 12.5 6H13.5C15.433 6 17 7.567 17 9.5ZM10 8C9.44772 8 9 8.44772 9 9C9 9.55228 9.44772 10 10 10C10.5523 10 11 9.55228 11 9C11 8.44772 10.5523 8 10 8Z" />
                            </svg>
                        </button>
                        <button class="hapus-daftar-btn text-red-500 hover:text-red-700 transition-colors duration-200" data-index="${index}" title="Hapus Barang">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 112 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                            </svg>
                        </button>
                        <button class="tambah-keranjang-btn px-4 py-1 text-sm bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors duration-200" data-index="${index}">Tambah ke Keranjang</button>
                    </div>
                `;
                daftarBarangContainer.appendChild(itemDiv);
            });

            // Menampilkan kontrol pagination
            updatePaginationControls();
        }
        
        // Fungsi untuk mengupdate tombol-tombol pagination
        function updatePaginationControls() {
            paginationControls.innerHTML = '';
            const totalPages = Math.ceil(daftarBarang.length / itemsPerPage);

            if (totalPages <= 1) return;

            for (let i = 1; i <= totalPages; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.textContent = i;
                pageBtn.className = `px-3 py-1 rounded-md transition-colors duration-200 ${i === currentPage ? 'bg-blue-600 text-white font-bold' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`;
                pageBtn.addEventListener('click', () => {
                    currentPage = i;
                    updateDaftarBarang();
                });
                paginationControls.appendChild(pageBtn);
            }
        }

        // Fungsi untuk mengupdate tampilan keranjang dan total harga
        function updateKeranjang() {
            keranjangContainer.innerHTML = '';
            
            if (keranjang.length === 0) {
                 keranjangContainer.innerHTML = `<p class="text-gray-500 italic">Keranjang belanja kosong.</p>`;
            }

            keranjang.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'flex justify-between items-center bg-white p-4 rounded-lg shadow-md';
                itemDiv.innerHTML = `
                    <div class="flex-1">
                        <span class="font-medium text-gray-800">${item.nama}</span>
                    </div>
                    <div class="text-right">
                        <span class="text-gray-600">Rp ${item.harga.toLocaleString('id-ID')}</span>
                    </div>
                    <button class="hapus-btn ml-4 text-red-500 hover:text-red-700 transition-colors duration-200" data-index="${index}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 112 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                        </svg>
                    </button>
                `;
                keranjangContainer.appendChild(itemDiv);
            });
            
            updateTotal();
        }

        // Fungsi untuk menghitung dan menampilkan total harga
        function updateTotal() {
            const total = keranjang.reduce((sum, item) => sum + item.harga, 0);
            totalHargaSpan.textContent = `Rp ${total.toLocaleString('id-ID')}`;
            hitungKembalian();
        }

        // Fungsi untuk menghitung dan menampilkan uang kembalian
        function hitungKembalian() {
            const total = keranjang.reduce((sum, item) => sum + item.harga, 0);
            const jumlahUang = parseInt(jumlahUangInput.value) || 0;
            const kembalian = jumlahUang - total;
            uangKembalianSpan.textContent = `Rp ${kembalian.toLocaleString('id-ID')}`;
            
            if (kembalian >= 0) {
                uangKembalianSpan.classList.remove('text-red-600');
                uangKembalianSpan.classList.add('text-green-700');
            } else {
                uangKembalianSpan.classList.remove('text-green-700');
                uangKembalianSpan.classList.add('text-red-600');
            }
        }

        // Menambahkan event listener ke tombol "Tambah Barang Baru"
        tambahBarangBtn.addEventListener('click', async () => {
            const itemsToSave = [];
            for (let i = 1; i <= 2; i++) {
                const nama = document.getElementById(`namaBarang${i}`).value.trim();
                const harga = parseInt(document.getElementById(`hargaBarang${i}`).value);
                
                if (nama !== '' && !isNaN(harga) && harga > 0) {
                    itemsToSave.push({ nama, harga });
                }
            }

            if (itemsToSave.length === 0) {
                alert('Silakan isi setidaknya satu pasang nama dan harga barang!');
                return;
            }

            try {
                for (const item of itemsToSave) {
                    const existingItem = daftarBarang.find(dbItem => dbItem.nama.toLowerCase() === item.nama.toLowerCase());
                    if (existingItem) {
                        const itemRef = doc(db, `artifacts/${appId}/users/${userId}/items`, existingItem.id);
                        await updateDoc(itemRef, { harga: item.harga });
                    } else {
                        const itemsCollection = collection(db, `artifacts/${appId}/users/${userId}/items`);
                        await addDoc(itemsCollection, { nama: item.nama, harga: item.harga });
                    }
                }
            } catch (error) {
                console.error("Error adding/updating document: ", error);
            }

            // Clear input fields
            for (let i = 1; i <= 2; i++) {
                document.getElementById(`namaBarang${i}`).value = '';
                document.getElementById(`hargaBarang${i}`).value = '';
            }
            document.getElementById('namaBarang1').focus();
        });

        // Menambahkan event listener untuk tombol hapus pada keranjang
        keranjangContainer.addEventListener('click', (event) => {
            if (event.target.closest('.hapus-btn')) {
                const index = event.target.closest('.hapus-btn').dataset.index;
                keranjang.splice(index, 1);
                updateKeranjang();
            }
        });

        // Menambahkan event listener untuk tombol di daftar barang
        daftarBarangContainer.addEventListener('click', async (event) => {
            const targetBtn = event.target.closest('.tambah-keranjang-btn');
            const updateBtn = event.target.closest('.perbarui-harga-btn');
            const deleteBtn = event.target.closest('.hapus-daftar-btn');
            
            if (targetBtn) {
                const index = targetBtn.dataset.index;
                const globalIndex = (currentPage - 1) * itemsPerPage + parseInt(index);
                keranjang.push(daftarBarang[globalIndex]);
                updateKeranjang();
            } else if (updateBtn) {
                const index = updateBtn.dataset.index;
                const globalIndex = (currentPage - 1) * itemsPerPage + parseInt(index);
                const item = daftarBarang[globalIndex];
                const inputHargaBaru = daftarBarangContainer.querySelector(`input[data-index="${index}"]`);
                const newPrice = parseInt(inputHargaBaru.value);
                
                if (!isNaN(newPrice) && newPrice > 0) {
                    try {
                        const itemRef = doc(db, `artifacts/${appId}/users/${userId}/items`, item.id);
                        await updateDoc(itemRef, { harga: newPrice });
                    } catch (error) {
                        console.error("Error updating document: ", error);
                    }
                } else {
                    alert('Harga baru harus berupa angka dan lebih dari 0.');
                }
            } else if (deleteBtn) {
                const index = deleteBtn.dataset.index;
                const globalIndex = (currentPage - 1) * itemsPerPage + parseInt(index);
                const item = daftarBarang[globalIndex];

                if (confirm('Apakah Anda yakin ingin menghapus barang ini?')) {
                    try {
                        const itemRef = doc(db, `artifacts/${appId}/users/${userId}/items`, item.id);
                        await deleteDoc(itemRef);
                    } catch (error) {
                        console.error("Error deleting document: ", error);
                    }
                }
            }
        });

        // Menambahkan event listener ke tombol "Reset Pembelian"
        resetBtn.addEventListener('click', () => {
            keranjang = [];
            jumlahUangInput.value = '';
            updateKeranjang();
        });
        
        // Menambahkan event listener ke tombol "Cetak Struk"
        cetakStrukBtn.addEventListener('click', () => {
            if (keranjang.length === 0) {
                alert('Keranjang belanja kosong. Silakan tambahkan barang terlebih dahulu.');
                return;
            }
            
            const total = keranjang.reduce((sum, item) => sum + item.harga, 0);
            const jumlahUang = parseInt(jumlahUangInput.value) || 0;
            const kembalian = jumlahUang - total;

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                unit: 'mm',
                format: [58, 150] // Ukuran kertas untuk printer termal mini (lebar 58mm, panjang 150mm)
            });
            
            const namaToko = "Kasir Kios";
            const tanggal = new Date().toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' });
            const waktu = new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });

            let y = 5;
            const marginX = 2;
            const fontSizeTitle = 8;
            const fontSizeNormal = 6;
            const lineHeight = 3.5;

            // Header Struk
            doc.setFontSize(fontSizeTitle);
            doc.text(namaToko, doc.internal.pageSize.getWidth() / 2, y, { align: 'center' });
            y += lineHeight;
            doc.setFontSize(fontSizeNormal);
            doc.text(`Tanggal: ${tanggal} ${waktu}`, marginX, y);
            y += lineHeight * 2;
            
            // Garis Pemisah
            doc.line(marginX, y, doc.internal.pageSize.getWidth() - marginX, y);
            y += lineHeight;
            
            // Daftar Barang
            keranjang.forEach(item => {
                doc.text(item.nama, marginX, y);
                doc.text(`Rp ${item.harga.toLocaleString('id-ID')}`, doc.internal.pageSize.getWidth() - marginX, y, { align: 'right' });
                y += lineHeight;
            });

            y += lineHeight;
            doc.line(marginX, y, doc.internal.pageSize.getWidth() - marginX, y);
            y += lineHeight;
            
            // Ringkasan Pembelian
            doc.setFontSize(fontSizeNormal);
            doc.text("Total:", marginX, y);
            doc.text(`Rp ${total.toLocaleString('id-ID')}`, doc.internal.pageSize.getWidth() - marginX, y, { align: 'right' });
            y += lineHeight;
            
            doc.text("Tunai:", marginX, y);
            doc.text(`Rp ${jumlahUang.toLocaleString('id-ID')}`, doc.internal.pageSize.getWidth() - marginX, y, { align: 'right' });
            y += lineHeight;
            
            doc.text("Kembalian:", marginX, y);
            doc.text(`Rp ${kembalian.toLocaleString('id-ID')}`, doc.internal.pageSize.getWidth() - marginX, y, { align: 'right' });
            y += lineHeight * 2;

            // Footer Struk
            doc.setFontSize(fontSizeNormal);
            doc.text("Terima kasih telah berbelanja!", doc.internal.pageSize.getWidth() / 2, y, { align: 'center' });
            
            doc.save("struk_pembelian.pdf");
        });

        // Menambahkan event listener ke input jumlah uang untuk menghitung kembalian
        jumlahUangInput.addEventListener('input', hitungKembalian);

        // Fungsi utama untuk memulai aplikasi setelah otentikasi
        function startApp() {
            const itemsCollection = collection(db, `artifacts/${appId}/users/${userId}/items`);
            daftarBarangUnsubscribe = onSnapshot(itemsCollection, (snapshot) => {
                daftarBarang = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateDaftarBarang();
            });
            updateKeranjang();
        }

    </script>
</body>
</html>
